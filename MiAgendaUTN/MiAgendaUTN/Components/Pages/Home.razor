@page "/"
@using System.Text.Json
@using Microsoft.Maui.Storage

<div class="mobile-container">
    <!-- Header -->
    <div class="mobile-header">
        <h1>📅 Mis Actividades</h1>
        <button class="btn-add" @onclick="MostrarFormulario">
            <span class="add-icon">+</span>
        </button>
    </div>

    <!-- Mensajes -->
    @if (!string.IsNullOrEmpty(mensaje))
    {
        <div class="alert-mobile">@mensaje</div>
    }

    <!-- Formulario para agregar/editar -->
    @if (mostrarFormulario)
    {
        <div class="form-overlay">
            <div class="form-container">
                <h3>@(editando ? "✏️ Editar" : "➕ Nueva") Actividad</h3>

                <div class="form-group">
                    <label>Título *</label>
                    <input class="form-input"
                           @bind="actividadActual.Titulo"
                           placeholder="Nombre de la actividad"
                           maxlength="50" />
                </div>

                <div class="form-group">
                    <label>Descripción *</label>
                    <textarea class="form-textarea"
                              @bind="actividadActual.Descripcion"
                              placeholder="Detalles..."
                              rows="3"></textarea>
                    @if (string.IsNullOrWhiteSpace(actividadActual.Descripcion))
                    {
                        <div class="error-message">La descripción es obligatoria.</div>
                    }
                </div>

                <div class="form-group">
                    <label>Fecha *</label>
                    <input type="date"
                           class="form-input"
                           @bind="actividadActual.Fecha" />
                </div>

                <div class="form-group">
                    <label>Categoría</label>
                    <select class="form-select" @bind="actividadActual.Categoria">
                        <option value="">Selecciona...</option>
                        <option value="Trabajo">💼 Trabajo</option>
                        <option value="Personal">👤 Personal</option>
                        <option value="Salud">🏥 Salud</option>
                        <option value="Estudio">📚 Estudio</option>
                        <option value="Social">👥 Social</option>
                        <option value="Otro">🔹 Otro</option>
                    </select>
                </div>

                <div class="form-buttons">
                    <button class="btn-secondary" @onclick="Cancelar">
                        Cancelar
                    </button>
                    <button class="btn-primary"
                            @onclick="GuardarActividad"
                            disabled="@(!CamposValidos)">
                        @(editando ? "💾 Actualizar" : "✅ Guardar")
                    </button>
                </div>
            </div>
        </div>
    }

    <!-- Lista de actividades -->
    @if (listaActividades.Count == 0)
    {
        <div class="empty-state">
            <div class="empty-icon">📅</div>
            <h3>No hay actividades</h3>
            <p>Agrega tu primera actividad presionando el botón "+"</p>
        </div>
    }
    else
    {
        <!-- Filtros rápidos -->
        <div class="filters">
            <button class="filter-chip @(filtroCategoria == "" ? "active" : "")"
                    @onclick="() => AplicarFiltro(string.Empty)">
                Todas
            </button>
            @foreach (var cat in categoriasUnicas)
            {
                <button class="filter-chip @(filtroCategoria == cat ? "active" : "")"
                        @onclick="() => AplicarFiltro(cat)">
                    @cat
                </button>
            }
        </div>

        <!-- Lista -->
        <div class="activities-list">
            @foreach (var actividad in actividadesFiltradas)
            {
                <div class="activity-card @(actividad.Fecha < DateTime.Today ? "past" : "")">
                    <div class="activity-header">
                        <span class="activity-title">@actividad.Titulo</span>
                        <span class="activity-date">
                            @actividad.Fecha.ToString("ddd, dd MMM")
                        </span>
                    </div>

                    @if (!string.IsNullOrEmpty(actividad.Descripcion))
                    {
                        <div class="activity-desc">@actividad.Descripcion</div>
                    }

                    <div class="activity-footer">
                        <span class="activity-category">
                            @ObtenerIconoCategoria(actividad.Categoria) @actividad.Categoria
                        </span>
                        <div class="activity-actions">
                            <button class="btn-icon"
                                    @onclick="() => EditarActividad(actividad)"
                                    title="Editar">
                                ✏️
                            </button>
                            <button class="btn-icon delete"
                                    @onclick="() => MostrarConfirmacionEliminar(actividad)"
                                    title="Eliminar">
                                🗑️
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }

    <!-- Confirmación de eliminación -->
    @if (actividadAEliminar != null)
    {
        <div class="modal-overlay">
            <div class="modal-container">
                <h3>¿Eliminar actividad?</h3>
                <p>¿Estás seguro de que quieres eliminar "@actividadAEliminar.Titulo"?</p>
                <div class="modal-buttons">
                    <button class="btn-secondary" @onclick="CancelarEliminacion">
                        Cancelar
                    </button>
                    <button class="btn-danger" @onclick="ConfirmarEliminacion">
                        🗑️ Eliminar
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<Actividad> listaActividades = new();
    private List<Actividad> actividadesFiltradas = new();
    private string rutaArchivo = Path.Combine(FileSystem.AppDataDirectory, "actividades.json");
    private Actividad actividadActual = new();
    private Actividad? actividadAEliminar = null;
    private bool editando = false;
    private bool mostrarFormulario = false;
    private string mensaje = string.Empty;
    private string filtroCategoria = "";

    protected override async Task OnInitializedAsync()
    {
        await CargarActividades();
    }

    private async Task CargarActividades()
    {
        if (File.Exists(rutaArchivo))
        {
            string json = await File.ReadAllTextAsync(rutaArchivo);
            listaActividades = JsonSerializer.Deserialize<List<Actividad>>(json) ?? new List<Actividad>();
            AplicarFiltro(filtroCategoria);
        }
    }

    private void MostrarFormulario()
    {
        actividadActual = new Actividad { Fecha = DateTime.Today };
        editando = false;
        mostrarFormulario = true;
    }

    private void EditarActividad(Actividad actividad)
    {
        actividadActual = new Actividad
        {
            Titulo = actividad.Titulo,
            Descripcion = actividad.Descripcion,
            Fecha = actividad.Fecha,
            Categoria = actividad.Categoria
        };
        editando = true;
        mostrarFormulario = true;
    }

    private async Task GuardarActividad()
    {
        if (!CamposValidos) return;

        if (editando)
        {
            var original = listaActividades.FirstOrDefault(a =>
                a.Titulo == actividadActual.Titulo &&
                a.Fecha == actividadActual.Fecha);
            if (original != null)
            {
                int index = listaActividades.IndexOf(original);
                listaActividades[index] = actividadActual;
            }
        }
        else
        {
            listaActividades.Add(actividadActual);
        }

        await GuardarCambiosEnArchivo();
        mensaje = editando ? "✅ Actividad actualizada" : "✅ Actividad guardada";
        mostrarFormulario = false;

        // Ocultar mensaje después de 3 segundos
        await Task.Delay(3000);
        mensaje = "";
    }

    private void Cancelar()
    {
        mostrarFormulario = false;
        actividadActual = new Actividad();
    }

    private void MostrarConfirmacionEliminar(Actividad actividad)
    {
        actividadAEliminar = actividad;
    }

    private async Task ConfirmarEliminacion()
    {
        if (actividadAEliminar != null && listaActividades.Remove(actividadAEliminar))
        {
            await GuardarCambiosEnArchivo();
            mensaje = "🗑️ Actividad eliminada";
            actividadAEliminar = null;

            await Task.Delay(3000);
            mensaje = "";
        }
    }

    private void CancelarEliminacion()
    {
        actividadAEliminar = null;
    }

    private void AplicarFiltro(string categoria)
    {
        filtroCategoria = categoria;
        actividadesFiltradas = string.IsNullOrEmpty(categoria)
            ? listaActividades
            : listaActividades.Where(a => a.Categoria == categoria).ToList();

        // Ordenar por fecha
        actividadesFiltradas = actividadesFiltradas
            .OrderBy(a => a.Fecha)
            .ThenBy(a => a.Titulo)
            .ToList();
    }

    private async Task GuardarCambiosEnArchivo()
    {
        string json = JsonSerializer.Serialize(listaActividades, new JsonSerializerOptions { WriteIndented = true });
        await File.WriteAllTextAsync(rutaArchivo, json);
        AplicarFiltro(filtroCategoria);
    }

    private string ObtenerIconoCategoria(string categoria)
    {
        return categoria switch
        {
            "Trabajo" => "💼",
            "Personal" => "👤",
            "Salud" => "🏥",
            "Estudio" => "📚",
            "Social" => "👥",
            _ => "🔹"
        };
    }

    private List<string> categoriasUnicas =>
        listaActividades.Select(a => a.Categoria)
                       .Where(c => !string.IsNullOrEmpty(c))
                       .Distinct()
                       .ToList();

    private bool CamposValidos =>
        !string.IsNullOrWhiteSpace(actividadActual.Titulo) &&
        !string.IsNullOrWhiteSpace(actividadActual.Descripcion) &&
        actividadActual.Fecha != default;

    public class Actividad
    {
        public string Titulo { get; set; } = string.Empty;
        public string Descripcion { get; set; } = string.Empty;
        public DateTime Fecha { get; set; }
        public string Categoria { get; set; } = string.Empty;
    }
}


<style>
    /* Estilos móviles */
    .mobile-container {
        max-width: 100%;
        padding: 16px;
        margin: 0 auto;
    }

    .mobile-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }

    .mobile-header h1 {
        font-size: 1.5rem;
        margin: 0;
        color: #333;
    }

    .btn-add {
        background: #007bff;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0,123,255,0.3);
        transition: transform 0.3s ease; /* Añadir una transición de escala */
    }

    .activities-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .activity-card {
        background: #f9f9f9; /* Fondo más claro para las tarjetas */
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1); /* Sombra más suave */
        border-left: 4px solid #007bff;
        transition: transform 0.3s ease, box-shadow 0.3s ease; /* Transición para el hover */
    }

    .activity-card.past {
        opacity: 0.7;
        border-left-color: #6c757d;
    }

    .activity-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
    }

    .activity-title {
        font-weight: bold;
        font-size: 1.2rem;
        color: #333;
        font-family: 'Poppins', sans-serif;
    }

    .activity-date {
        font-size: 0.9rem;
        color: #666;
        white-space: nowrap;
    }

    .activity-desc {
        color: #666;
        margin-bottom: 12px;
        line-height: 1.4;
    }

    .activity-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .activity-category {
        font-size: 0.9rem;
        color: #666;
    }

    .activity-actions {
        display: flex;
        gap: 8px;
    }

    .btn-icon {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 4px;
    }

    .btn-icon.delete {
        color: #dc3545;
    }

    /* Formulario overlay */
    .form-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
    }

    .form-container {
        background: white;
        border-radius: 16px;
        padding: 24px;
        width: 100%;
        max-width: 400px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
    }

    .form-group {
        margin-bottom: 16px;
    }

    .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: #333;
    }

    .form-input, .form-textarea, .form-select {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        box-sizing: border-box;
    }

    .form-buttons {
        display: flex;
        gap: 12px;
        margin-top: 20px;
    }

    .btn-primary {
        flex: 1;
        background: #007bff;
        color: white;
        border: none;
        padding: 12px;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .btn-secondary {
        flex: 1;
        background: #6c757d;
        color: white;
        border: none;
        padding: 12px;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    /* Filtros */
    .filters {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        overflow-x: auto;
        padding-bottom: 8px;
    }

    .filter-chip {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 20px;
        padding: 8px 16px;
        font-size: 0.9rem;
        white-space: nowrap;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .filter-chip.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }

    /* Estados vacíos y mensajes */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
    }

    .empty-icon {
        font-size: 3rem;
        margin-bottom: 16px;
    }

    .alert-mobile {
        background: #d4edda;
        color: #155724;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 16px;
        text-align: center;
    }

    /* Modal de confirmación */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
    }

    .modal-container {
        background: white;
        border-radius: 16px;
        padding: 24px;
        width: 100%;
        max-width: 300px;
        text-align: center;
    }

    .modal-buttons {
        display: flex;
        gap: 12px;
        margin-top: 20px;
    }

    .btn-danger {
        flex: 1;
        background: #dc3545;
        color: white;
        border: none;
        padding: 12px;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
    }
</style>
