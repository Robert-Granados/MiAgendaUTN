@page "/agendar"
@using System.Text.Json
@using System.ComponentModel.DataAnnotations
@using MiAgendaUTN.ViewModels

<EditForm EditContext="@editContext" OnValidSubmit="@GuardarActividad">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="form-group">
        <label>Título:</label>
        <InputText @bind-Value="nuevaActividad.Titulo" class="form-control" />
        <ValidationMessage For="@(() => nuevaActividad.Titulo)" />
    </div>

    <div class="form-group">
        <label>Descripción:</label>
        <InputTextArea @bind-Value="nuevaActividad.Descripcion" class="form-control" />
        <ValidationMessage For="@(() => nuevaActividad.Descripcion)" />
    </div>

    <div class="form-group">
        <label>Fecha:</label>
        <InputDate @bind-Value="nuevaActividad.Fecha" class="form-control" />
        <ValidationMessage For="@(() => nuevaActividad.Fecha)" />
    </div>

    <div class="form-group">
        <label>Categoría / Etiqueta:</label>
        <InputSelect @bind-Value="nuevaActividad.Categoria" class="form-control">
            <option value="">-- Selecciona una categoría --</option>
            <option>Trabajo</option>
            <option>Estudio</option>
            <option>Personal</option>
            <option>Salud</option>
            <option>Otro</option>
        </InputSelect>
        <ValidationMessage For="@(() => nuevaActividad.Categoria)" />
    </div>

    <button type="submit" class="btn-guardar" disabled="@actividadGuardada">Guardar Actividad</button>
</EditForm>

@if (actividadGuardada){
    <p class="mensaje-exito">✅ Actividad guardada correctamente</p>
}

@code {
    private ActivityModel nuevaActividad = new();
    private EditContext editContext;
    private bool actividadGuardada = false;
    private List<ActivityModel> listaActividades = new();

    private string rutaArchivo = Path.Combine(FileSystem.AppDataDirectory, "actividades.json");

    protected override void OnInitialized(){
        editContext = new EditContext(nuevaActividad);
    }

    private async void GuardarActividad()
    {
        if (!editContext.Validate())
        {
            Console.WriteLine("❌ Formulario inválido.");
            return;
        }

        if (File.Exists(rutaArchivo))
        {
            string jsonExistente = await File.ReadAllTextAsync(rutaArchivo);
            listaActividades = JsonSerializer.Deserialize<List<ActivityModel>>(jsonExistente) ?? new();
        }

        listaActividades.Add(nuevaActividad);

        string json = JsonSerializer.Serialize(listaActividades, new JsonSerializerOptions { WriteIndented = true });
        await File.WriteAllTextAsync(rutaArchivo, json);

        actividadGuardada = true;

   
        await Task.Delay(50);
        nuevaActividad = new ActivityModel();
        editContext = new EditContext(nuevaActividad);
        StateHasChanged();
    }
}
